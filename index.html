<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢—Ä–µ–Ω–∞–∂–µ—Ä –ø–æ –ú–∞—Ç–µ–º–∞—Ç–∏–∫–µ</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #282c34;
            --surface-color: #3b4049;
            --primary-color: #61dafb;
            --secondary-color: #98c379;
            --accent-color: #e06c75;
            --operator-color: #c678dd;
            --operator-hover: #be50e7;
            --text-color: #abb2bf;
            --text-light: #ffffff;
            --success-color: #98c379;
            --error-color: #e06c75;
            --gold-color: #ffd700;
            --silver-color: #c0c0c0;
            --bronze-color: #b87333;
        }

        html {
            font-size: 16px;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Roboto', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 1.25rem;
            box-sizing: border-box;
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        #app-container, #welcome-view {
            width: 720px;
            height: 1600px;
            max-height: 95vh;
            background-color: var(--surface-color);
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 0.3125rem 1.25rem rgba(0,0,0,0.4);
            position: relative;
            overflow-y: auto; /* Scrolling is enabled */
            scrollbar-width: none; /* Hide scrollbar for Firefox */
            -ms-overflow-style: none;  /* Hide scrollbar for IE and Edge */
        }
        
        /* Hide scrollbar for Chrome, Safari and Opera */
        #app-container::-webkit-scrollbar,
        #welcome-view::-webkit-scrollbar {
            display: none;
        }

        .hidden { display: none !important; }

        h1, h2 {
            text-align: center;
            color: var(--text-light);
            margin-top: 0;
            margin-bottom: 1.25rem;
        }

        button, .button-style {
            display: inline-block;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            border: none;
            color: var(--text-light);
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s ease, background-color 0.2s;
            width: 100%;
            box-sizing: border-box;
            margin-top: 0.625rem;
            text-align: center;
        }
        button:hover, .button-style:hover { transform: translateY(-0.125rem); }
        button:disabled {
            background-color: #5c626d;
            cursor: not-allowed;
            transform: none;
        }

        input[type="text"], input[type="tel"] {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 0.625rem;
            border-radius: 0.5rem;
            border: 0.125rem solid #555;
            background-color: #4a4f58;
            color: var(--text-light);
            font-size: 1em;
            box-sizing: border-box;
        }
        input[type="text"]::placeholder, input[type="tel"]::placeholder { color: var(--text-color); }

        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        #header-profile-widget {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 1.5rem;
            transition: background-color 0.3s;
        }
        #header-profile-widget:hover {
            background-color: rgba(255,255,255,0.1);
        }
        #header-avatar {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary-color);
        }
        #header-username {
            font-weight: bold;
            color: var(--text-light);
        }
        #header-gold-display {
            font-weight: bold;
            color: var(--gold-color);
            background-color: rgba(0,0,0,0.2);
            padding: 0.25rem 0.6rem;
            border-radius: 1rem;
            font-size: 0.9em;
        }

        .mode-switch-btn { background-color: var(--secondary-color); }
        .mode-switch-btn:hover { background-color: #82a865; }

        #home-view {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            align-items: center;
        }
        .home-menu-btn {
            font-size: 1.5em;
            padding: 1.5rem;
        }
        #go-to-achievements-btn {
            background-color: var(--gold-color);
            color: var(--bg-color);
        }
        #go-to-achievements-btn:hover {
            background-color: #e6c300;
        }

        .study-view-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }
        #problem-display {
            font-size: clamp(2.5em, 10vw, 4.5em);
            font-weight: bold;
            color: var(--primary-color);
            font-family: 'Courier New', Courier, monospace;
        }
        #answer-input {
            font-size: clamp(2em, 9vw, 4em);
            font-family: 'Courier New', Courier, monospace;
            text-align: center;
            max-width: 300px;
            padding: 0.5rem;
            height: auto;
        }
        .study-controls {
            display: flex;
            gap: 1rem;
            width: 100%;
            max-width: 400px;
            margin-top: 1rem;
        }
        .study-controls button {
            margin-top: 0;
            padding: 1rem;
            font-size: 1.2em;
        }
        #check-answer-btn { background-color: #56b6c2; }
        #check-answer-btn:hover { background-color: #45939e; }
        .back-to-home-btn { background-color: var(--accent-color); }
        .back-to-home-btn:hover { background-color: #c8414b; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center;
            z-index: 1000; cursor: pointer; opacity: 1; transition: opacity 0.3s ease;
        }
        .modal-overlay.hidden { opacity: 0; pointer-events: none; }
        .modal-content {
            background: var(--surface-color); padding: 1.5rem 2rem; border-radius: 0.75rem;
            box-shadow: 0 0.3125rem 1.5rem rgba(0,0,0,0.5); text-align: center;
            width: 90%; max-width: 400px; cursor: default; position: relative;
        }
        .modal-message { font-size: 1.1em; color: var(--text-light); }
        .modal-message.success { color: var(--success-color); }
        .modal-message.error { color: var(--error-color); }
        .modal-message.achievement { color: var(--gold-color); font-weight: bold; }
        .achievement-title { font-size: 1.5em; margin-bottom: 0.3125rem; }
        .achievement-icon { font-size: 2.5em; margin-bottom: 0.625rem; }
        .achievement-description { font-size: 1em; margin-top: 0.5rem; color: var(--text-color); }
        .achievement-reward { font-size: 1.2em; margin-top: 0.75rem; color: var(--gold-color); font-weight: bold;}
        
        .modal-close-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: transparent;
            border: none;
            font-size: 2.5em; /* Increased size */
            color: var(--text-color);
            cursor: pointer;
            padding: 0;
            margin: 0;
            line-height: 1;
            width: 2.5rem; /* Increased clickable area */
            height: 2.5rem; /* Increased clickable area */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-close-btn:hover { 
            color: var(--text-light);
            transform: none; /* Override default button hover */
        }

        .achievement-item {
            background-color: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 0.5rem; margin-bottom: 0.625rem;
            display: flex; align-items: center; gap: 1rem; transition: background-color 0.3s;
        }
        .achievement-item.unlocked { background-color: rgba(255, 215, 0, 0.15); }
        .achievement-icon-list { font-size: 2.5em; color: #666; }
        .achievement-item.unlocked .achievement-icon-list { color: var(--gold-color); }
        .achievement-details { text-align: left; }
        .achievement-name { font-size: 1.1em; font-weight: bold; color: #999; }
        .achievement-item.unlocked .achievement-name { color: var(--text-light); }
        .achievement-desc { font-size: 0.9em; color: #777; }
        .achievement-item.unlocked .achievement-desc { color: var(--text-color); }

        #profile-view {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #profile-picture {
            width: 12.5rem; height: 12.5rem; border-radius: 50%;
            border: 0.25rem solid var(--primary-color);
            object-fit: cover; background-color: #4a4f58;
            margin-bottom: 1.25rem;
        }
        #photo-upload-label { background-color: var(--operator-color); }
        #photo-upload-label:hover { background-color: var(--operator-hover); }
        #save-profile-btn { background-color: var(--success-color); }
        #save-profile-btn:hover { background-color: #82a865; }
        input[type="file"] { display: none; }
        #profile-name-input {
            text-align: center;
            font-size: 1.2em;
        }
        #profile-status-input {
            text-align: center;
            font-size: 1.1em;
            border-color: var(--secondary-color);
            color: var(--secondary-color);
        }
        #profile-status-input::placeholder {
            color: rgba(152, 195, 121, 0.7);
        }
        #profile-gold-container {
            background-color: rgba(0,0,0,0.2);
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 1.5rem 0;
            text-align: center;
            border: 1px solid var(--gold-color);
        }
        #profile-gold-display {
            font-size: 2em;
            font-weight: bold;
            color: var(--gold-color);
            text-shadow: 0 0 8px var(--gold-color);
        }
        #profile-gold-label {
            font-size: 1em;
            color: var(--text-color);
            margin-top: 0.25rem;
            display: block;
        }
        #medal-container {
            margin-top: 1.5rem;
            text-align: center;
        }
        #medal-icon {
            font-size: 6rem;
            transition: color 0.5s, opacity 0.5s, text-shadow 0.5s;
        }
        .medal-transparent {
            opacity: 0.3;
            color: var(--text-color);
            text-shadow: none;
        }
        .medal-bronze {
            color: var(--bronze-color);
            text-shadow: 0 0 8px var(--bronze-color);
            opacity: 1;
        }
        .medal-silver {
            color: var(--silver-color);
            text-shadow: 0 0 8px var(--silver-color);
            opacity: 1;
        }
        .medal-gold {
            color: var(--gold-color);
            text-shadow: 0 0 8px var(--gold-color);
            opacity: 1;
        }
        #medal-description {
            margin-top: 0.5rem;
            font-size: 0.9em;
            color: var(--text-color);
            min-height: 1.2em;
        }

    </style>
</head>
<body>

    <div id="welcome-view">
        <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –¢—Ä–µ–Ω–∞–∂–µ—Ä!</h1>
        <p>–ö–∞–∫ –∫ —Ç–µ–±–µ –æ–±—Ä–∞—â–∞—Ç—å—Å—è?</p>
        <input type="text" id="name-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è...">
        <button id="start-btn" class="mode-switch-btn">–ù–∞—á–∞—Ç—å!</button>
    </div>

    <div id="app-container" class="hidden">
        <div class="app-header">
            <h1 id="view-title">–ì–ª–∞–≤–Ω–æ–µ –ú–µ–Ω—é</h1>
            <div id="header-profile-widget" title="–ü–µ—Ä–µ–π—Ç–∏ –≤ –ø—Ä–æ—Ñ–∏–ª—å">
                <span id="header-username"></span>
                <span id="header-gold-display"></span>
                <img id="header-avatar" src="https://placehold.co/40x40/4a4f58/abb2bf?text=?" alt="–ê–≤–∞—Ç–∞—Ä">
            </div>
        </div>

        <div id="home-view">
            <h2 id="home-greeting">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º</h2>
            <button id="go-to-multiplication-btn" class="home-menu-btn mode-switch-btn">–¢–∞–±–ª–∏—Ü–∞ —É–º–Ω–æ–∂–µ–Ω–∏—è</button>
            <button id="go-to-single-digit-btn" class="home-menu-btn mode-switch-btn">–°–ª–æ–∂–µ–Ω–∏–µ –æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã—Ö</button>
            <button id="go-to-double-digit-btn" class="home-menu-btn mode-switch-btn">–°–ª–æ–∂–µ–Ω–∏–µ –¥–≤—É–∑–Ω–∞—á–Ω—ã—Ö</button>
            <button id="go-to-squares-btn" class="home-menu-btn mode-switch-btn">–ö–≤–∞–¥—Ä–∞—Ç—ã</button>
            <button id="go-to-roots-btn" class="home-menu-btn mode-switch-btn">–ö–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ –∫–æ—Ä–Ω–∏</button>
            <button id="go-to-achievements-btn" class="home-menu-btn">–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</button>
        </div>

        <div id="study-view" class="hidden">
            <div class="study-view-content">
                <div id="problem-display"></div>
                <input type="tel" id="answer-input" inputmode="numeric" pattern="[0-9]*" placeholder="–û—Ç–≤–µ—Ç">
                <div class="study-controls">
                    <button id="check-answer-btn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
                </div>
                 <button id="back-to-home-from-study-btn" class="back-to-home-btn">–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é</button>
            </div>
        </div>
        
        <div id="achievements-view" class="hidden">
            <div id="achievements-list"></div>
            <button id="back-to-home-from-achievements-btn" class="back-to-home-btn">–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é</button>
        </div>

        <div id="profile-view" class="hidden">
            <img id="profile-picture" src="https://placehold.co/200x200/4a4f58/abb2bf?text=–§–æ—Ç–æ" alt="–§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è">
            <input type="file" id="photo-upload" accept="image/*">
            <label for="photo-upload" id="photo-upload-label" class="button-style">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</label>
            <input type="text" id="profile-name-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è...">
            <input type="text" id="profile-status-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à —Å—Ç–∞—Ç—É—Å...">
            <div id="profile-gold-container">
                <span id="profile-gold-display"></span>
                <span id="profile-gold-label">–í—Å–µ–≥–æ –≥–æ–ª–¥—ã</span>
            </div>
            <div id="medal-container">
                <span id="medal-icon"></span>
                <p id="medal-description"></p>
            </div>
            <button id="save-profile-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button id="back-to-home-from-profile-btn" class="back-to-home-btn">–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é</button>
        </div>

        <div id="notification-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <button id="modal-close-btn" class="modal-close-btn">√ó</button>
                <p id="modal-message" class="modal-message"></p>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const MathTrainerApp = {
            init() {
                this.setupProperties();
                this.defineAchievements();
                this.loadData();
                this.bindEvents();
                this.updateGoldDisplay();

                if (this.userName) {
                    this.welcomeView.classList.add('hidden');
                    this.appContainer.classList.remove('hidden');
                    this.updateHeader();
                    this.switchToView('home');
                } else {
                    this.welcomeView.classList.remove('hidden');
                    this.appContainer.classList.add('hidden');
                }
            },

            setupProperties() {
                // Views
                this.homeView = document.getElementById('home-view');
                this.studyView = document.getElementById('study-view');
                this.achievementsView = document.getElementById('achievements-view');
                this.profileView = document.getElementById('profile-view');
                this.welcomeView = document.getElementById('welcome-view');
                this.appContainer = document.getElementById('app-container');

                // Common
                this.viewTitle = document.getElementById('view-title');
                this.homeGreeting = document.getElementById('home-greeting');
                this.modal = document.getElementById('notification-modal');
                this.modalMessage = document.getElementById('modal-message');

                // Header
                this.headerProfileWidget = document.getElementById('header-profile-widget');
                this.headerAvatar = document.getElementById('header-avatar');
                this.headerUsername = document.getElementById('header-username');
                this.headerGoldDisplay = document.getElementById('header-gold-display');
                
                // Profile
                this.profilePicture = document.getElementById('profile-picture');
                this.profileNameInput = document.getElementById('profile-name-input');
                this.profileStatusInput = document.getElementById('profile-status-input');
                this.profileGoldDisplay = document.getElementById('profile-gold-display');
                this.medalIcon = document.getElementById('medal-icon');
                this.medalDescription = document.getElementById('medal-description');

                // Study Mode
                this.problemDisplay = document.getElementById('problem-display');
                this.answerInput = document.getElementById('answer-input');

                // Achievements
                this.achievementsListContainer = document.getElementById('achievements-list');

                // State
                this.userName = '';
                this.userPhoto = '';
                this.userStatus = '';
                this.userGold = 0;
                this.stats = {};
                this.dailyStats = {};
                this.currentMode = null;
                this.currentAnswer = null;
                this.messageTimeout = null;
                
                // Feedback phrases
                this.positiveFeedback = ['–¢—É–¥–∞!', '–ì–æ–æ–æ–ª!', '–ß–∏–Ω–∞–∑–µ—Å!', '–ö—Ä—É—Ç—ã—à!', '–£—Ä—è!', '–ú–æ–ª–æ–¥–µ—Ü!', '–£–º–Ω—è—à–∫–∞!'];
                this.negativeFeedback = ['–ü–æ–¥—É–º–æ–π!', '–ì–æ –ø–æ–ø—Ä–æ–±—É–µ–º –µ—â—ë —Ä–∞–∑...', '–¢–æ–ª—å–∫–æ –Ω–µ –ø–ª–∞—á—å!', '–ß—É—Ç—å –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–µ–µ...', '–ê –µ—Å–ª–∏ –ø–æ-–¥—Ä—É–≥–æ–º—É?', '–ü–æ—á—Ç–∏!'];
            },
            
            defineAchievements() {
                const REWARD = 10; // –ù–∞–≥—Ä–∞–¥–∞ –∑–∞ –∫–∞–∂–¥–æ–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ
                this.achievements = {
                    general: [
                        { id: 'g_first', name: '–ü–µ—Ä–≤—ã–π —à–∞–≥', description: '–†–µ—à–∏—Ç—å —Å–≤–æ–π –ø–µ—Ä–≤—ã–π –ø—Ä–∏–º–µ—Ä.', icon: 'üå±', condition: stats => (stats.total.multiplication + stats.total.singleDigit + stats.total.doubleDigit + stats.total.squares + stats.total.roots) >= 1, reward: REWARD },
                        { id: 'g_all_modes', name: '–†–∞–∑–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–π', description: '–†–µ—à–∏—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø—Ä–∏–º–µ—Ä –≤ –∫–∞–∂–¥–æ–º —Ä–µ–∂–∏–º–µ.', icon: 'üß†', condition: stats => stats.total.multiplication > 0 && stats.total.singleDigit > 0 && stats.total.doubleDigit > 0 && stats.total.squares > 0 && stats.total.roots > 0, reward: REWARD },
                        { id: 'g_total_25', name: '–ù–∞—á–∏–Ω–∞—é—â–∏–π', description: '–†–µ—à–∏—Ç—å 25 –ø—Ä–∏–º–µ—Ä–æ–≤ –≤ —Å—É–º–º–µ.', icon: 'üßë‚Äçüéì', condition: stats => (stats.total.multiplication + stats.total.singleDigit + stats.total.doubleDigit + stats.total.squares + stats.total.roots) >= 25, reward: REWARD },
                        { id: 'g_total_50', name: '–£—á–µ–Ω–∏–∫', description: '–†–µ—à–∏—Ç—å 50 –ø—Ä–∏–º–µ—Ä–æ–≤ –≤ —Å—É–º–º–µ.', icon: 'üë®‚Äçüéì', condition: stats => (stats.total.multiplication + stats.total.singleDigit + stats.total.doubleDigit + stats.total.squares + stats.total.roots) >= 50, reward: REWARD },
                        { id: 'g_total_100', name: '–ó–Ω–∞—Ç–æ–∫', description: '–†–µ—à–∏—Ç—å 100 –ø—Ä–∏–º–µ—Ä–æ–≤ –≤ —Å—É–º–º–µ.', icon: 'üßê', condition: stats => (stats.total.multiplication + stats.total.singleDigit + stats.total.doubleDigit + stats.total.squares + stats.total.roots) >= 100, reward: REWARD },
                        { id: 'g_total_250', name: '–≠–∫—Å–ø–µ—Ä—Ç', description: '–†–µ—à–∏—Ç—å 250 –ø—Ä–∏–º–µ—Ä–æ–≤ –≤ —Å—É–º–º–µ.', icon: 'üë©‚Äçüè´', condition: stats => (stats.total.multiplication + stats.total.singleDigit + stats.total.doubleDigit + stats.total.squares + stats.total.roots) >= 250, reward: REWARD },
                        { id: 'g_total_500', name: '–í–µ—Ç–µ—Ä–∞–Ω', description: '–†–µ—à–∏—Ç—å 500 –ø—Ä–∏–º–µ—Ä–æ–≤ –≤ —Å—É–º–º–µ.', icon: 'üèõÔ∏è', condition: stats => (stats.total.multiplication + stats.total.singleDigit + stats.total.doubleDigit + stats.total.squares + stats.total.roots) >= 500, reward: REWARD },
                        { id: 'g_gold_100', name: '–ö–æ–ø–∏–ª–∫–∞', description: '–ó–∞—Ä–∞–±–æ—Ç–∞—Ç—å 100 –≥–æ–ª–¥—ã.', icon: 'üí∞', condition: (stats, gold) => gold >= 100, reward: REWARD },
                        { id: 'g_gold_500', name: '–°–æ–∫—Ä–æ–≤–∏—â–Ω–∏—Ü–∞', description: '–ó–∞—Ä–∞–±–æ—Ç–∞—Ç—å 500 –≥–æ–ª–¥—ã.', icon: 'üíé', condition: (stats, gold) => gold >= 500, reward: REWARD },
                        { id: 'g_gold_1000', name: '–ó–æ–ª–æ—Ç–∞—è –ª–∏—Ö–æ—Ä–∞–¥–∫–∞', description: '–ó–∞—Ä–∞–±–æ—Ç–∞—Ç—å 1000 –≥–æ–ª–¥—ã.', icon: 'üèÜ', condition: (stats, gold) => gold >= 1000, reward: REWARD },
                    ],
                    addition: [
                        { id: 's_milestone10', name: '–ü–µ—Ä–≤—ã–µ —à–∞–≥–∏ –≤ —Å–ª–æ–∂–µ–Ω–∏–∏', description: '–†–µ—à–∏—Ç—å 10 –ø—Ä–∏–º–µ—Ä–æ–≤ –Ω–∞ —Å–ª–æ–∂–µ–Ω–∏–µ –æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã—Ö.', icon: '‚ûï', condition: stats => stats.total.singleDigit >= 10, reward: REWARD },
                        { id: 's_milestone25', name: '–°–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –æ—Ç–ª–∏—á–Ω–æ', description: '–†–µ—à–∏—Ç—å 25 –ø—Ä–∏–º–µ—Ä–æ–≤ –Ω–∞ —Å–ª–æ–∂–µ–Ω–∏–µ –æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã—Ö.', icon: 'üëç', condition: stats => stats.total.singleDigit >= 25, reward: REWARD },
                        { id: 's_milestone50', name: '–ú–∞—Å—Ç–µ—Ä –ø—Ä–æ—Å—Ç–æ–≥–æ —Å—á–µ—Ç–∞', description: '–†–µ—à–∏—Ç—å 50 –ø—Ä–∏–º–µ—Ä–æ–≤ –Ω–∞ —Å–ª–æ–∂–µ–Ω–∏–µ –æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã—Ö.', icon: 'üèÖ', condition: stats => stats.total.singleDigit >= 50, reward: REWARD },
                        { id: 's_milestone100', name: '–ö–æ—Ä–æ–ª—å –æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã—Ö', description: '–†–µ—à–∏—Ç—å 100 –ø—Ä–∏–º–µ—Ä–æ–≤ –Ω–∞ —Å–ª–æ–∂–µ–Ω–∏–µ –æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã—Ö.', icon: 'üëë', condition: stats => stats.total.singleDigit >= 100, reward: REWARD },
                        { id: 's_streak10', name: '–°–µ—Ä–∏—è –±–µ–∑ –æ—à–∏–±–æ–∫', description: '–†–µ—à–∏—Ç—å 10 –ø—Ä–∏–º–µ—Ä–æ–≤ –Ω–∞ —Å–ª–æ–∂–µ–Ω–∏–µ –æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã—Ö –ø–æ–¥—Ä—è–¥.', icon: 'üéØ', condition: stats => stats.streaks.singleDigit >= 10, reward: REWARD },
                        { id: 'd_milestone10', name: '–î–≤—É–∑–Ω–∞—á–Ω—ã–π –¥–µ–±—é—Ç', description: '–†–µ—à–∏—Ç—å 10 –ø—Ä–∏–º–µ—Ä–æ–≤ –Ω–∞ —Å–ª–æ–∂–µ–Ω–∏–µ –¥–≤—É–∑–Ω–∞—á–Ω—ã—Ö.', icon: '‚öôÔ∏è', condition: stats => stats.total.doubleDigit >= 10, reward: REWARD },
                        { id: 'd_milestone25', name: '–ò–Ω–∂–µ–Ω–µ—Ä–Ω—ã–π –ø–æ–¥—Ö–æ–¥', description: '–†–µ—à–∏—Ç—å 25 –ø—Ä–∏–º–µ—Ä–æ–≤ –Ω–∞ —Å–ª–æ–∂–µ–Ω–∏–µ –¥–≤—É–∑–Ω–∞—á–Ω—ã—Ö.', icon: 'üìê', condition: stats => stats.total.doubleDigit >= 25, reward: REWARD },
                        { id: 'd_milestone50', name: '–ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä —á–∏—Å–µ–ª', description: '–†–µ—à–∏—Ç—å 50 –ø—Ä–∏–º–µ—Ä–æ–≤ –Ω–∞ —Å–ª–æ–∂–µ–Ω–∏–µ –¥–≤—É–∑–Ω–∞—á–Ω—ã—Ö.', icon: 'üèóÔ∏è', condition: stats => stats.total.doubleDigit >= 50, reward: REWARD },
                        { id: 'd_milestone100', name: '–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –≥–µ–Ω–∏–π', description: '–†–µ—à–∏—Ç—å 100 –ø—Ä–∏–º–µ—Ä–æ–≤ –Ω–∞ —Å–ª–æ–∂–µ–Ω–∏–µ –¥–≤—É–∑–Ω–∞—á–Ω—ã—Ö.', icon: 'üíπ', condition: stats => stats.total.doubleDigit >= 100, reward: REWARD },
                        { id: 'd_streak10', name: '–¢–æ—á–Ω—ã–π —Ä–∞—Å—á–µ—Ç', description: '–†–µ—à–∏—Ç—å 10 –ø—Ä–∏–º–µ—Ä–æ–≤ –Ω–∞ —Å–ª–æ–∂–µ–Ω–∏–µ –¥–≤—É–∑–Ω–∞—á–Ω—ã—Ö –ø–æ–¥—Ä—è–¥.', icon: 'üíØ', condition: stats => stats.streaks.doubleDigit >= 10, reward: REWARD },
                    ],
                    multiplication: [
                        { id: 'm_milestone10', name: '–ó–Ω–∞–∫–æ–º—Å—Ç–≤–æ —Å —Ç–∞–±–ª–∏—Ü–µ–π', description: '–†–µ—à–∏—Ç—å 10 –ø—Ä–∏–º–µ—Ä–æ–≤ –Ω–∞ —É–º–Ω–æ–∂–µ–Ω–∏–µ.', icon: 'üéì', condition: stats => stats.total.multiplication >= 10, reward: REWARD },
                        { id: 'm_milestone25', name: '–£–≤–µ—Ä–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', description: '–†–µ—à–∏—Ç—å 25 –ø—Ä–∏–º–µ—Ä–æ–≤ –Ω–∞ —É–º–Ω–æ–∂–µ–Ω–∏–µ.', icon: 'üìö', condition: stats => stats.total.multiplication >= 25, reward: REWARD },
                        { id: 'm_milestone50', name: '–ú–∞–≥–∏—Å—Ç—Ä —É–º–Ω–æ–∂–µ–Ω–∏—è', description: '–†–µ—à–∏—Ç—å 50 –ø—Ä–∏–º–µ—Ä–æ–≤ –Ω–∞ —É–º–Ω–æ–∂–µ–Ω–∏–µ.', icon: 'üßô', condition: stats => stats.total.multiplication >= 50, reward: REWARD },
                        { id: 'm_milestone100', name: '–ü—Ä–æ—Ñ–µ—Å—Å–æ—Ä', description: '–†–µ—à–∏—Ç—å 100 –ø—Ä–∏–º–µ—Ä–æ–≤ –Ω–∞ —É–º–Ω–æ–∂–µ–Ω–∏–µ.', icon: 'üè´', condition: stats => stats.total.multiplication >= 100, reward: REWARD },
                        { id: 'm_milestone200', name: '–õ–µ–≥–µ–Ω–¥–∞ —Ç–∞–±–ª–∏—Ü—ã', description: '–†–µ—à–∏—Ç—å 200 –ø—Ä–∏–º–µ—Ä–æ–≤ –Ω–∞ —É–º–Ω–æ–∂–µ–Ω–∏–µ.', icon: 'üåå', condition: stats => stats.total.multiplication >= 200, reward: REWARD },
                        { id: 'm_streak5', name: '–ù–∞ –ø–æ—Ç–æ–∫–µ', description: '–†–µ—à–∏—Ç—å 5 –ø—Ä–∏–º–µ—Ä–æ–≤ –Ω–∞ —É–º–Ω–æ–∂–µ–Ω–∏–µ –ø–æ–¥—Ä—è–¥.', icon: 'üî•', condition: stats => stats.streaks.multiplication >= 5, reward: REWARD },
                        { id: 'm_streak10', name: '–ù–µ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å', description: '–†–µ—à–∏—Ç—å 10 –ø—Ä–∏–º–µ—Ä–æ–≤ –Ω–∞ —É–º–Ω–æ–∂–µ–Ω–∏–µ –ø–æ–¥—Ä—è–¥.', icon: 'üöÄ', condition: stats => stats.streaks.multiplication >= 10, reward: REWARD },
                        { id: 'm_streak15', name: '–û–≥–Ω–µ–Ω–Ω–∞—è —Å–µ—Ä–∏—è', description: '–†–µ—à–∏—Ç—å 15 –ø—Ä–∏–º–µ—Ä–æ–≤ –Ω–∞ —É–º–Ω–æ–∂–µ–Ω–∏–µ –ø–æ–¥—Ä—è–¥.', icon: '‚òÑÔ∏è', condition: stats => stats.streaks.multiplication >= 15, reward: REWARD },
                        { id: 'm_streak20', name: '–ë–µ–∑—É–ø—Ä–µ—á–Ω–æ—Å—Ç—å', description: '–†–µ—à–∏—Ç—å 20 –ø—Ä–∏–º–µ—Ä–æ–≤ –Ω–∞ —É–º–Ω–æ–∂–µ–Ω–∏–µ –ø–æ–¥—Ä—è–¥.', icon: '‚ú®', condition: stats => stats.streaks.multiplication >= 20, reward: REWARD },
                        { id: 'm_streak25', name: '–ú–∞—à–∏–Ω–Ω–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å', description: '–†–µ—à–∏—Ç—å 25 –ø—Ä–∏–º–µ—Ä–æ–≤ –Ω–∞ —É–º–Ω–æ–∂–µ–Ω–∏–µ –ø–æ–¥—Ä—è–¥.', icon: 'ü§ñ', condition: stats => stats.streaks.multiplication >= 25, reward: REWARD },
                    ],
                    squares: [
                        { id: 'sq_milestone10', name: '–ü–µ—Ä–≤—ã–µ —Å—Ç–µ–ø–µ–Ω–∏', description: '–í–æ–∑–≤–µ—Å—Ç–∏ –≤ –∫–≤–∞–¥—Ä–∞—Ç 10 —á–∏—Å–µ–ª.', icon: 'üìê', condition: stats => stats.total.squares >= 10, reward: REWARD },
                        { id: 'sq_milestone25', name: '–ö–≤–∞–¥—Ä–∞—Ç–Ω—ã–π —É–º', description: '–í–æ–∑–≤–µ—Å—Ç–∏ –≤ –∫–≤–∞–¥—Ä–∞—Ç 25 —á–∏—Å–µ–ª.', icon: 'üß±', condition: stats => stats.total.squares >= 25, reward: REWARD },
                        { id: 'sq_milestone50', name: '–ú–∞—Å—Ç–µ—Ä –∫–≤–∞–¥—Ä–∞—Ç–æ–≤', description: '–í–æ–∑–≤–µ—Å—Ç–∏ –≤ –∫–≤–∞–¥—Ä–∞—Ç 50 —á–∏—Å–µ–ª.', icon: 'üèóÔ∏è', condition: stats => stats.total.squares >= 50, reward: REWARD },
                        { id: 'sq_milestone100', name: '–ü–æ–≤–µ–ª–∏—Ç–µ–ª—å —Å—Ç–µ–ø–µ–Ω–µ–π', description: '–í–æ–∑–≤–µ—Å—Ç–∏ –≤ –∫–≤–∞–¥—Ä–∞—Ç 100 —á–∏—Å–µ–ª.', icon: 'üèõÔ∏è', condition: stats => stats.total.squares >= 100, reward: REWARD },
                        { id: 'sq_milestone200', name: '–õ–µ–≥–µ–Ω–¥–∞ –∫–≤–∞–¥—Ä–∞—Ç–æ–≤', description: '–í–æ–∑–≤–µ—Å—Ç–∏ –≤ –∫–≤–∞–¥—Ä–∞—Ç 200 —á–∏—Å–µ–ª.', icon: 'üåá', condition: stats => stats.total.squares >= 200, reward: REWARD },
                        { id: 'sq_streak5', name: '–î–≤–æ–π–Ω–æ–π —É–¥–∞—Ä', description: '–í–æ–∑–≤–µ—Å—Ç–∏ –≤ –∫–≤–∞–¥—Ä–∞—Ç 5 —á–∏—Å–µ–ª –ø–æ–¥—Ä—è–¥.', icon: 'üî•', condition: stats => stats.streaks.squares >= 5, reward: REWARD },
                        { id: 'sq_streak10', name: '–ö–≤–∞–¥—Ä–∞—Ç–Ω–∞—è —Å–µ—Ä–∏—è', description: '–í–æ–∑–≤–µ—Å—Ç–∏ –≤ –∫–≤–∞–¥—Ä–∞—Ç 10 —á–∏—Å–µ–ª –ø–æ–¥—Ä—è–¥.', icon: 'üöÄ', condition: stats => stats.streaks.squares >= 10, reward: REWARD },
                        { id: 'sq_streak15', name: '–°—Ç–µ–ø–µ–Ω—å —Ç–æ—á–Ω–æ—Å—Ç–∏', description: '–í–æ–∑–≤–µ—Å—Ç–∏ –≤ –∫–≤–∞–¥—Ä–∞—Ç 15 —á–∏—Å–µ–ª –ø–æ–¥—Ä—è–¥.', icon: 'üéØ', condition: stats => stats.streaks.squares >= 15, reward: REWARD },
                        { id: 'sq_streak20', name: '–ë–µ–∑—É–ø—Ä–µ—á–Ω—ã–π –∫–≤–∞–¥—Ä–∞—Ç', description: '–í–æ–∑–≤–µ—Å—Ç–∏ –≤ –∫–≤–∞–¥—Ä–∞—Ç 20 —á–∏—Å–µ–ª –ø–æ–¥—Ä—è–¥.', icon: '‚ú®', condition: stats => stats.streaks.squares >= 20, reward: REWARD },
                        { id: 'sq_streak25', name: '–°–æ–≤–µ—Ä—à–µ–Ω–Ω–∞—è —Å—Ç–µ–ø–µ–Ω—å', description: '–í–æ–∑–≤–µ—Å—Ç–∏ –≤ –∫–≤–∞–¥—Ä–∞—Ç 25 —á–∏—Å–µ–ª –ø–æ–¥—Ä—è–¥.', icon: 'ü§ñ', condition: stats => stats.streaks.squares >= 25, reward: REWARD },
                    ],
                    roots: [
                        { id: 'rt_milestone10', name: '–í –ø–æ–∏—Å–∫–∞—Ö –∫–æ—Ä–Ω–µ–π', description: '–ò–∑–≤–ª–µ—á—å 10 –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã—Ö –∫–æ—Ä–Ω–µ–π.', icon: 'üå≥', condition: stats => stats.total.roots >= 10, reward: REWARD },
                        { id: 'rt_milestone25', name: '–ö–æ—Ä–µ–Ω–Ω–æ–π –∂–∏—Ç–µ–ª—å', description: '–ò–∑–≤–ª–µ—á—å 25 –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã—Ö –∫–æ—Ä–Ω–µ–π.', icon: 'üè°', condition: stats => stats.total.roots >= 25, reward: REWARD },
                        { id: 'rt_milestone50', name: '–ú–∞—Å—Ç–µ—Ä –∏–∑–≤–ª–µ—á–µ–Ω–∏–π', description: '–ò–∑–≤–ª–µ—á—å 50 –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã—Ö –∫–æ—Ä–Ω–µ–π.', icon: 'üõ†Ô∏è', condition: stats => stats.total.roots >= 50, reward: REWARD },
                        { id: 'rt_milestone100', name: '–ü—Ä–æ—Ñ–µ—Å—Å–æ—Ä –†–∞–¥–∏–∫–∞–ª–æ–≤', description: '–ò–∑–≤–ª–µ—á—å 100 –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã—Ö –∫–æ—Ä–Ω–µ–π.', icon: 'üßë‚Äçüè´', condition: stats => stats.total.roots >= 100, reward: REWARD },
                        { id: 'rt_milestone200', name: '–õ–µ–≥–µ–Ω–¥–∞ –∫–æ—Ä–Ω–µ–π', description: '–ò–∑–≤–ª–µ—á—å 200 –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã—Ö –∫–æ—Ä–Ω–µ–π.', icon: 'üìú', condition: stats => stats.total.roots >= 200, reward: REWARD },
                        { id: 'rt_streak5', name: '–î–æ–∫–æ–ø–∞—Ç—å—Å—è –¥–æ —Å—É—Ç–∏', description: '–ò–∑–≤–ª–µ—á—å 5 –∫–æ—Ä–Ω–µ–π –ø–æ–¥—Ä—è–¥.', icon: 'üî•', condition: stats => stats.streaks.roots >= 5, reward: REWARD },
                        { id: 'rt_streak10', name: '–ö–æ—Ä–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞', description: '–ò–∑–≤–ª–µ—á—å 10 –∫–æ—Ä–Ω–µ–π –ø–æ–¥—Ä—è–¥.', icon: 'üöÄ', condition: stats => stats.streaks.roots >= 10, reward: REWARD },
                        { id: 'rt_streak15', name: '–†–∞–¥–∏–∫–∞–ª—å–Ω–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å', description: '–ò–∑–≤–ª–µ—á—å 15 –∫–æ—Ä–Ω–µ–π –ø–æ–¥—Ä—è–¥.', icon: 'üéØ', condition: stats => stats.streaks.roots >= 15, reward: REWARD },
                        { id: 'rt_streak20', name: '–ë–µ–∑—É–ø—Ä–µ—á–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ', description: '–ò–∑–≤–ª–µ—á—å 20 –∫–æ—Ä–Ω–µ–π –ø–æ–¥—Ä—è–¥.', icon: '‚ú®', condition: stats => stats.streaks.roots >= 20, reward: REWARD },
                        { id: 'rt_streak25', name: '–ò–Ω—Ç—É–∏—Ü–∏—è –≥–µ–Ω–∏—è', description: '–ò–∑–≤–ª–µ—á—å 25 –∫–æ—Ä–Ω–µ–π –ø–æ–¥—Ä—è–¥.', icon: 'üí°', condition: stats => stats.streaks.roots >= 25, reward: REWARD },
                    ]
                };
            },
            
            bindEvents() {
                document.getElementById('start-btn').addEventListener('click', this.startApp.bind(this));
                
                this.headerProfileWidget.addEventListener('click', () => this.switchToView('profile'));
                document.getElementById('photo-upload').addEventListener('change', this.handlePhotoUpload.bind(this));
                document.getElementById('save-profile-btn').addEventListener('click', this.saveProfile.bind(this));
                
                document.getElementById('go-to-multiplication-btn').addEventListener('click', () => this.startStudy('multiplication'));
                document.getElementById('go-to-single-digit-btn').addEventListener('click', () => this.startStudy('singleDigit'));
                document.getElementById('go-to-double-digit-btn').addEventListener('click', () => this.startStudy('doubleDigit'));
                document.getElementById('go-to-squares-btn').addEventListener('click', () => this.startStudy('squares'));
                document.getElementById('go-to-roots-btn').addEventListener('click', () => this.startStudy('roots'));
                document.getElementById('go-to-achievements-btn').addEventListener('click', () => this.switchToView('achievements'));

                document.getElementById('back-to-home-from-study-btn').addEventListener('click', () => this.switchToView('home'));
                document.getElementById('back-to-home-from-achievements-btn').addEventListener('click', () => this.switchToView('home'));
                document.getElementById('back-to-home-from-profile-btn').addEventListener('click', () => this.switchToView('home'));

                document.getElementById('check-answer-btn').addEventListener('click', this.checkAnswer.bind(this));
                this.answerInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') this.checkAnswer();
                });

                this.modal.addEventListener('click', (e) => {
                    if (e.target.id === 'notification-modal') this.hideMessage();
                });
                document.getElementById('modal-close-btn').addEventListener('click', this.hideMessage.bind(this));
            },
            
            loadData() {
                this.userName = localStorage.getItem('mathTrainerUser') || '';
                this.userPhoto = localStorage.getItem('mathTrainerPhoto') || '';
                this.userStatus = localStorage.getItem('mathTrainerStatus') || '';
                this.userGold = parseInt(localStorage.getItem('mathTrainerGold'), 10) || 0;
                
                const today = new Date().toISOString().split('T')[0];
                const storedDailyStats = JSON.parse(localStorage.getItem('mathTrainerDailyStats'));
                if (storedDailyStats && storedDailyStats.date === today) {
                    this.dailyStats = storedDailyStats;
                    if (!this.dailyStats.dailyMedalRewardLevel) {
                        this.dailyStats.dailyMedalRewardLevel = 'none';
                    }
                } else {
                    this.dailyStats = { date: today, solvedCount: 0, dailyMedalRewardLevel: 'none' };
                }
                
                const savedStats = JSON.parse(localStorage.getItem('mathTrainerStats'));
                this.stats = {
                    total: (savedStats && savedStats.total) || { multiplication: 0, singleDigit: 0, doubleDigit: 0, squares: 0, roots: 0 },
                    streaks: (savedStats && savedStats.streaks) || { multiplication: 0, singleDigit: 0, doubleDigit: 0, squares: 0, roots: 0 },
                    unlockedAchievements: (savedStats && savedStats.unlockedAchievements) || []
                };
            },

            saveData() {
                localStorage.setItem('mathTrainerUser', this.userName);
                localStorage.setItem('mathTrainerPhoto', this.userPhoto);
                localStorage.setItem('mathTrainerStatus', this.userStatus);
                localStorage.setItem('mathTrainerGold', this.userGold);
                localStorage.setItem('mathTrainerDailyStats', JSON.stringify(this.dailyStats));
                localStorage.setItem('mathTrainerStats', JSON.stringify(this.stats));
            },

            startApp() {
                const nameInput = document.getElementById('name-input');
                const name = nameInput.value.trim();
                if (name) {
                    this.userName = name;
                    this.saveData();
                    this.welcomeView.classList.add('hidden');
                    this.appContainer.classList.remove('hidden');
                    this.updateHeader();
                    this.switchToView('home');
                } else {
                    this.showMessage('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è.', 'error');
                }
            },
            
            updateHeader() {
                this.headerUsername.textContent = this.userName;
                this.headerAvatar.src = this.userPhoto || 'https://placehold.co/40x40/4a4f58/abb2bf?text=?';
                this.updateGoldDisplay();
            },
            
            updateGoldDisplay() {
                const goldString = `üí∞ ${this.userGold}`;
                this.headerGoldDisplay.textContent = goldString;
                if(this.profileGoldDisplay) this.profileGoldDisplay.textContent = goldString;
            },

            switchToView(viewName) {
                [this.homeView, this.studyView, this.achievementsView, this.profileView].forEach(v => v.classList.add('hidden'));
                
                const titles = {
                    home: '–ì–ª–∞–≤–Ω–æ–µ –ú–µ–Ω—é',
                    study: `–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞: ${this.getModeName()}`,
                    achievements: '–ú–æ–∏ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è',
                    profile: '–ú–æ–π –ü—Ä–æ—Ñ–∏–ª—å'
                };
                this.viewTitle.textContent = titles[viewName] || '–¢—Ä–µ–Ω–∞–∂–µ—Ä';

                this.headerProfileWidget.style.visibility = (viewName === 'study') ? 'hidden' : 'visible';

                switch(viewName) {
                    case 'home':
                        this.homeGreeting.textContent = `–ü—Ä–∏–≤–µ—Ç, ${this.userName}! –í—ã–±–µ—Ä–∏ —Ä–µ–∂–∏–º`;
                        this.homeView.classList.remove('hidden');
                        break;
                    case 'study':
                        this.studyView.classList.remove('hidden');
                        break;
                    case 'achievements':
                        this.renderAchievementsList();
                        this.achievementsView.classList.remove('hidden');
                        break;
                    case 'profile':
                        this.renderProfileView();
                        this.profileView.classList.remove('hidden');
                        break;
                }
            },
            
            getModeName() {
                switch(this.currentMode) {
                    case 'multiplication': return '–£–º–Ω–æ–∂–µ–Ω–∏–µ';
                    case 'singleDigit': return '–°–ª–æ–∂–µ–Ω–∏–µ –æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã—Ö';
                    case 'doubleDigit': return '–°–ª–æ–∂–µ–Ω–∏–µ –¥–≤—É–∑–Ω–∞—á–Ω—ã—Ö';
                    case 'squares': return '–ö–≤–∞–¥—Ä–∞—Ç—ã';
                    case 'roots': return '–ö–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ –∫–æ—Ä–Ω–∏';
                    default: return '';
                }
            },

            startStudy(mode) {
                this.currentMode = mode;
                this.switchToView('study');
                this.generateProblem();
            },

            generateProblem() {
                let num1, num2, question;
                switch (this.currentMode) {
                    case 'multiplication':
                        num1 = Math.floor(Math.random() * 9) + 2;
                        num2 = Math.floor(Math.random() * 9) + 2;
                        this.currentAnswer = num1 * num2;
                        question = `${num1} √ó ${num2}`;
                        break;
                    case 'singleDigit':
                        num1 = Math.floor(Math.random() * 10);
                        num2 = Math.floor(Math.random() * 10);
                        this.currentAnswer = num1 + num2;
                        question = `${num1} + ${num2}`;
                        break;
                    case 'doubleDigit':
                        num1 = Math.floor(Math.random() * 90) + 10;
                        num2 = Math.floor(Math.random() * 90) + 10;
                        this.currentAnswer = num1 + num2;
                        question = `${num1} + ${num2}`;
                        break;
                    case 'squares':
                        num1 = Math.floor(Math.random() * 16) + 1; // 1 to 16
                        this.currentAnswer = num1 * num1;
                        question = `${num1}¬≤`;
                        break;
                    case 'roots':
                        num1 = Math.floor(Math.random() * 16) + 1; // 1 to 16
                        const squareNum = num1 * num1;
                        this.currentAnswer = num1;
                        question = `‚àö${squareNum}`;
                        break;
                }
                this.problemDisplay.textContent = question;
                this.answerInput.value = '';
                this.answerInput.focus();
            },

            checkAnswer() {
                const userAnswer = parseInt(this.answerInput.value, 10);
                if (isNaN(userAnswer)) {
                    this.showMessage('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ.', 'error');
                    return;
                }

                if (userAnswer === this.currentAnswer) {
                    let goldFromAnswer = 0;
                    switch (this.currentMode) {
                        case 'singleDigit': goldFromAnswer = 2; break;
                        case 'doubleDigit': goldFromAnswer = 3; break;
                        case 'multiplication': goldFromAnswer = 4; break;
                        case 'squares': goldFromAnswer = 5; break;
                        case 'roots': goldFromAnswer = 6; break;
                    }
                    this.userGold += goldFromAnswer;

                    this.dailyStats.solvedCount++;
                    this.stats.total[this.currentMode]++;
                    this.stats.streaks[this.currentMode]++;
                    Object.keys(this.stats.streaks).forEach(key => {
                        if (key !== this.currentMode) this.stats.streaks[key] = 0;
                    });

                    let medalData = null;
                    const count = this.dailyStats.solvedCount;
                    const currentMedalLevel = this.dailyStats.dailyMedalRewardLevel || 'none';
                    const MEDAL_REWARD = 5;

                    if (count === 1 && currentMedalLevel === 'none') {
                        this.userGold += MEDAL_REWARD;
                        this.dailyStats.dailyMedalRewardLevel = 'bronze';
                        medalData = { name: '–ë—Ä–æ–Ω–∑–æ–≤–∞—è –º–µ–¥–∞–ª—å –¥–Ω—è!', icon: 'ü•â', description: '–í—ã —Ä–µ—à–∏–ª–∏ —Å–≤–æ—é –ø–µ—Ä–≤—É—é –∑–∞–¥–∞—á—É —Å–µ–≥–æ–¥–Ω—è!' };
                    } else if (count === 10 && currentMedalLevel === 'bronze') {
                        this.userGold += MEDAL_REWARD;
                        this.dailyStats.dailyMedalRewardLevel = 'silver';
                        medalData = { name: '–°–µ—Ä–µ–±—Ä—è–Ω–∞—è –º–µ–¥–∞–ª—å –¥–Ω—è!', icon: 'ü•à', description: '–í—ã —Ä–µ—à–∏–ª–∏ 10 –∑–∞–¥–∞—á –∑–∞ —Å–µ–≥–æ–¥–Ω—è!' };
                    } else if (count === 30 && currentMedalLevel === 'silver') {
                        this.userGold += MEDAL_REWARD;
                        this.dailyStats.dailyMedalRewardLevel = 'gold';
                        medalData = { name: '–ó–æ–ª–æ—Ç–∞—è –º–µ–¥–∞–ª—å –¥–Ω—è!', icon: 'ü•á', description: '–í—ã —Ä–µ—à–∏–ª–∏ 30 –∑–∞–¥–∞—á –∑–∞ —Å–µ–≥–æ–¥–Ω—è!' };
                    }

                    this.saveData();
                    this.updateGoldDisplay();

                    const newAchievement = this.checkAchievements();

                    let nextProblemDelay = 1000;
                    if (newAchievement) {
                        this.unlockAchievement(newAchievement);
                        nextProblemDelay = 2600;
                    } else if (medalData) {
                        const medalHTML = `<div class="achievement-title">${medalData.name}</div><div class="achievement-icon">${medalData.icon}</div><p class="achievement-description">${medalData.description}</p><p class="achievement-reward">+${MEDAL_REWARD} üí∞</p>`;
                        this.showMessage(medalHTML, 'achievement', 2500, true);
                        nextProblemDelay = 2600;
                    } else {
                        const randomPhrase = this.positiveFeedback[Math.floor(Math.random() * this.positiveFeedback.length)];
                        this.showMessage(`${randomPhrase} (+${goldFromAnswer} üí∞)`, 'success', 1500);
                        nextProblemDelay = 1600;
                    }
                    
                    setTimeout(() => this.generateProblem(), nextProblemDelay);

                } else {
                    const randomPhrase = this.negativeFeedback[Math.floor(Math.random() * this.negativeFeedback.length)];
                    this.showMessage(randomPhrase, 'error');
                    if (navigator.vibrate) navigator.vibrate(200);

                    this.answerInput.value = '';
                    this.answerInput.focus();

                    this.stats.streaks[this.currentMode] = 0;
                    this.saveData();
                }
            },

            handlePhotoUpload(e) {
                const file = e.target.files[0];
                if (!file) return;
                if (file.size > 5 * 1024 * 1024) {
                    this.showMessage('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π! (–ú–∞–∫—Å–∏–º—É–º 5 –ú–ë)', 'error');
                    return;
                }
                const reader = new FileReader();
                reader.onload = (event) => {
                    this.userPhoto = event.target.result;
                    this.profilePicture.src = this.userPhoto;
                };
                reader.readAsDataURL(file);
            },

            saveProfile() {
                const newName = this.profileNameInput.value.trim();
                const newStatus = this.profileStatusInput.value.trim();
                
                if (newName) {
                    this.userName = newName;
                    this.userStatus = newStatus; 
                    this.saveData();
                    this.updateHeader();
                    this.showMessage('–ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!', 'success');
                    this.switchToView('home');
                } else {
                    this.showMessage('–ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.', 'error');
                }
            },

            renderProfileView() {
                this.profileNameInput.value = this.userName;
                this.profileStatusInput.value = this.userStatus;
                this.profilePicture.src = this.userPhoto || 'https://placehold.co/200x200/4a4f58/abb2bf?text=–§–æ—Ç–æ';
                this.updateGoldDisplay();
                this.updateMedal();
            },
            
            updateMedal() {
                const count = this.dailyStats.solvedCount;
                this.medalIcon.className = 'medal-icon';

                if (count >= 30) {
                    this.medalIcon.textContent = 'ü•á';
                    this.medalIcon.classList.add('medal-gold');
                    this.medalDescription.textContent = '–ó–æ–ª–æ—Ç–∞—è –º–µ–¥–∞–ª—å! (–°–µ–≥–æ–¥–Ω—è —Ä–µ—à–µ–Ω–æ 30+)';
                } else if (count >= 10) {
                    this.medalIcon.textContent = 'ü•à';
                    this.medalIcon.classList.add('medal-silver');
                    this.medalDescription.textContent = '–°–µ—Ä–µ–±—Ä—è–Ω–∞—è –º–µ–¥–∞–ª—å! (–°–µ–≥–æ–¥–Ω—è —Ä–µ—à–µ–Ω–æ 10-29)';
                } else if (count > 0) {
                    this.medalIcon.textContent = 'ü•â';
                    this.medalIcon.classList.add('medal-bronze');
                    this.medalDescription.textContent = '–ë—Ä–æ–Ω–∑–æ–≤–∞—è –º–µ–¥–∞–ª—å! (–°–µ–≥–æ–¥–Ω—è —Ä–µ—à–µ–Ω–æ 1-9)';
                } else {
                    this.medalIcon.textContent = '‚ùî';
                    this.medalIcon.classList.add('medal-transparent');
                    this.medalDescription.textContent = '–†–µ—à–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∑–∞–¥–∞—á—É —Å–µ–≥–æ–¥–Ω—è!';
                }
            },

            renderAchievementsList() {
                this.achievementsListContainer.innerHTML = '';
                const categoryTitles = {
                    general: '–û–±—â–∏–µ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è',
                    addition: '–°–ª–æ–∂–µ–Ω–∏–µ',
                    multiplication: '–£–º–Ω–æ–∂–µ–Ω–∏–µ',
                    squares: '–ö–≤–∞–¥—Ä–∞—Ç—ã',
                    roots: '–ö–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ –∫–æ—Ä–Ω–∏'
                };

                for (const categoryKey in this.achievements) {
                    const category = this.achievements[categoryKey];
                    
                    const titleElement = document.createElement('h2');
                    titleElement.textContent = categoryTitles[categoryKey];
                    this.achievementsListContainer.appendChild(titleElement);

                    category.forEach(ach => {
                        const isUnlocked = this.stats.unlockedAchievements.includes(ach.id);
                        const item = document.createElement('div');
                        item.className = `achievement-item ${isUnlocked ? 'unlocked' : 'locked'}`;
                        item.innerHTML = `<div class="achievement-icon-list">${ach.icon}</div><div class="achievement-details"><div class="achievement-name">${ach.name}</div><div class="achievement-desc">${ach.description}</div></div>`;
                        this.achievementsListContainer.appendChild(item);
                    });
                }
            },
            
            checkAchievements() {
                for (const categoryKey in this.achievements) {
                    for (const ach of this.achievements[categoryKey]) {
                        if (!this.stats.unlockedAchievements.includes(ach.id) && ach.condition(this.stats, this.userGold)) {
                            return ach;
                        }
                    }
                }
                return null;
            },
            
            unlockAchievement(achievement) {
                if(this.stats.unlockedAchievements.includes(achievement.id)) return;
                
                this.stats.unlockedAchievements.push(achievement.id);
                this.userGold += achievement.reward;
                this.saveData();
                this.updateGoldDisplay();
                
                const achievementHTML = `<div class="achievement-title">${achievement.name}</div><div class="achievement-icon">${achievement.icon}</div><p class="achievement-description">${achievement.description}</p><p class="achievement-reward">+${achievement.reward} üí∞</p>`;
                this.showMessage(achievementHTML, 'achievement', 2500, true);
            },

            showMessage(message, type = 'info', duration = 1500, isHTML = false) {
                clearTimeout(this.messageTimeout);
                
                if (isHTML) {
                    this.modalMessage.innerHTML = message;
                } else {
                    this.modalMessage.textContent = message;
                }

                this.modalMessage.className = `modal-message ${type}`;
                this.modal.classList.remove('hidden');

                if (duration > 0) {
                     this.messageTimeout = setTimeout(() => {
                         this.hideMessage();
                     }, duration);
                }
            },
            
            hideMessage() {
                if(!this.modal.classList.contains('hidden')) {
                    this.modal.classList.add('hidden');
                }
                clearTimeout(this.messageTimeout);
            }
        };

        MathTrainerApp.init();
    });
    </script>
</body>
</html>